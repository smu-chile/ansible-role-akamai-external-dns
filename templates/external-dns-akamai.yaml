apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: external-dns-akamai
  namespace: default
spec:
  encryptedData:
    EXTERNAL_DNS_AKAMAI_ACCESS_TOKEN: AQB7oDKRUHSk8T+pb80Xwk+U+iDBiex/R/gezAaLPq+G6HM7qGeynMCeSUSgMHOxwqGpQ1oxgFRJ5tLRXGS5gB5IPOschIY3FN8Wu9ijgp5BwNfs3l0oSZFfKFZIUctApz9vt9yyzpQATt6Eh9iNFWy0yyohXrNoSVuJJWF2paqrH2mgCrx4XHTB6PpQj6it3R2hWTchFd45ECjHvhfuz6ol/SqsF6JISv5Ql3ePRq+v9If6Y1X9U8VaMqyunOKnCvVCerEEN/bBxrZhCrXJC7bJcw4I59kXFFujtpIbPFYtHF/YPAfvrKvOPvASS5eb9vFU1y/fWf58Ih4qtwK12AanP6YOj7V+hHWneqkpEL0lupEzIM1hgJ2NXPdhugvYKlgF8jv8ygC6fakCnnAryN2+Y2My5KSM
    EXTERNAL_DNS_AKAMAI_CLIENT_SECRET: AQCcf9dy3Gu+xkwNrBTvYwp7R5nyJuKD2Xox9gyg1y7sAlQ7F3xklNgXa9UJWH80Aach1ymtt51wFhk35/DSZ4X5WeHLJIVuzjHn9eSe925u8nujGxyrPH8ScSk5WImVkiLhH9elDPU8lI/4lbwmH3LgnOHMkJJVAfBZE5vUKejCQH9sio5cmZa+nl7AuKZLfEF62nxIgQAa8nTcX/bKxVhSSLNFZqE92eNi0L/Y9v4wEZWonz/rqtPS/50Wo2EUNwAQoLK5yZF13J6kcKOWOOu15wL2Z+2dpiZjGDWNGPQoQAPISNsh+e4tUiM8alGN3fzo8me9jztEaREqRC6+ll7mzt6PFPrwuoO1sSxNz5JoaZelibQ5Wpeuj0g+er8fpGXp6IgoULzR288muACLvfNlxLVjZNM6xM+gq/ks
    EXTERNAL_DNS_AKAMAI_CLIENT_TOKEN: AQBEGwOXbb/FT989ekXMLGG/Gqq9oBY7RMOGGoE1ZuMuiZgZIj3py6/vkL1lDcmmWE47GimYYDyJ6JF8nwHRgnbNsGN0rNyisPvQf6v44DZnWh6GmZyBqxu51/0XmBcnSwMTlolRiAYO0blhMhOE/545ul43TMkPRv7LnndZWYObJjUYDxQu7Osh1CkCqcbezto8/hsNLCUrD6jg4pRAEpFWSVwoVtnXc9yYMXmT7z/HL7VMdVLBnbjqE0EJZtGgUllbVx654LSAAnM1kwBHOmfM78llyhK1AnvPSngDrHXxrKNHFSryvRWLwbhLZloR2NGFZnMc+F6VVDvvP3LTxYwKXa/ExS+NlDoDQX3FNE7oBzR7CjmX8PuhSPJ8VJYyd/+6KM1NsgzydbaddkRazv7ecJGN8MmJ
    EXTERNAL_DNS_AKAMAI_SERVICECONSUMERDOMAIN: AQAGQvP7eeXWPdD6mfY8SiseeCArifF43cDEwgdcUXarMRTVt3+O33LPVYw6s6skV2DQ2+9infFeqD8iksTuFgqdBfSORFa5VLsAe2J+MSWYlU7S9JsxFm6d/bqgrq7O3gNnp/dELJjES4enBarzO1luIIckFiSDsCHVHPZfhPjaVJ75XCi/Inc1aHHuqVPpKQsFeovyTRrN49Nd7VG5+5lKs6pxVMpTf6CQdo4iX95dTDgzVCGnTfSGMsbMbtLBHypBDufsjxkd1UvbNCyXYukKTOSHApV+EH/WN6u2yUguMoVpTeyIkRTJxZtjVzuZDFSI1xlnZMo0bS4x9h5fweCyAwc1YASxIsBwH3HD95jk46e/nQzhfC/6NjGD1xoxwPelgErClQtaTu6yH4jFGqdxxSOd5CK41msOpZKkTXfwqTKxBzQHximyOFM=
  template:
    data: null
    metadata:
      creationTimestamp: null
      name: external-dns-akamai
      namespace: default
    type: Opaque
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-dns
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns
rules:
- apiGroups: [""]
  resources: ["services","endpoints","pods"]
  verbs: ["get","watch","list"]
- apiGroups: ["extensions","networking.k8s.io"]
  resources: ["ingresses"]
  verbs: ["get","watch","list"]
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["watch", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-viewer
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns
subjects:
- kind: ServiceAccount
  name: external-dns
  namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: external-dns
  template:
    metadata:
      labels:
        app: external-dns
    spec:
      serviceAccountName: external-dns
      containers:
      - name: external-dns
        image: registry.k8s.io/external-dns/external-dns:v0.14.2
        args:
        - --source=ingress 
        - --source=service  # or ingress or both
        - --provider=akamai
        # zone-id-filter may be specified as well to filter on contract ID
        - --registry=txt
        - --txt-owner-id={{ CLUSTER_NAME }} # example aws-virginia-portal-ventas-produccion
        - --txt-prefix=_txt_
        - --log-level=trace
        - --annotation-filter=external-dns.alpha.kubernetes.io/exclude notin (true)
        env:
        - name: EXTERNAL_DNS_AKAMAI_SERVICECONSUMERDOMAIN
          valueFrom:
            secretKeyRef:
              name: external-dns-akamai
              key: EXTERNAL_DNS_AKAMAI_SERVICECONSUMERDOMAIN
        - name: EXTERNAL_DNS_AKAMAI_CLIENT_TOKEN
          valueFrom:
            secretKeyRef:
              name: external-dns-akamai
              key: EXTERNAL_DNS_AKAMAI_CLIENT_TOKEN
        - name: EXTERNAL_DNS_AKAMAI_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: external-dns-akamai
              key: EXTERNAL_DNS_AKAMAI_CLIENT_SECRET
        - name: EXTERNAL_DNS_AKAMAI_ACCESS_TOKEN
          valueFrom:
            secretKeyRef:
              name: external-dns-akamai
              key: EXTERNAL_DNS_AKAMAI_ACCESS_TOKEN